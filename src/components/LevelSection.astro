---
import type { Activity } from "@/lib/contentful";
import type { Level } from "@/lib/constants";
import ActivityPreview from "@/components/ActivityPreview.astro";

interface Props {
  level: Level;
  activities: Activity[];
  defaultCollapsed?: boolean;
  eagerCount?: number;
}

const { level, activities, defaultCollapsed = false, eagerCount = 0 } = Astro.props;

if (!activities || activities.length === 0) return;

const LEVEL_META: Record<string, { emoji: string; color: string; label: string }> = {
  A1: { emoji: "üê£", color: "from-secondary-very-light to-white", label: "D√©butant" },
  A2: { emoji: "üê•", color: "from-tertiary-light to-white", label: "√âl√©mentaire" },
  B1: { emoji: "üë∂", color: "from-primary-light to-white", label: "Interm√©diaire" },
  B2: { emoji: "üéì", color: "from-secondary-light/40 to-white", label: "Avanc√©" },
  C1: { emoji: "üë®", color: "from-primary-light to-white", label: "Autonome" },
  C2: { emoji: "üßì", color: "from-tertiary-light to-white", label: "Ma√Ætrise" },
};

const meta = LEVEL_META[level] || { emoji: "üìö", color: "from-gray-100 to-gray-50", label: "" };
const sectionId = `level-${level.toLowerCase()}`;
const isExpanded = !defaultCollapsed;
---

<section data-level-section>
  {/* Clickable header */}
  <button
    type="button"
    data-level-toggle={sectionId}
    aria-expanded={isExpanded ? "true" : "false"}
    aria-controls={sectionId}
    class={`w-full rounded-2xl bg-gradient-to-r ${meta.color} px-5 py-4 sm:px-6 sm:py-5 cursor-pointer select-none transition-all duration-200 hover:brightness-95 active:scale-[0.99]`}
  >
    <div class="flex items-center justify-between flex-wrap gap-2">
      <div class="flex items-center gap-3">
        <span class="text-2xl sm:text-3xl" aria-hidden="true">{meta.emoji}</span>
        <div class="text-left">
          <h2 class="text-lg sm:text-xl font-bold text-primary-dark leading-tight">
            Niveau {level}
          </h2>
          {meta.label && (
            <p class="text-xs sm:text-sm text-primary/70 font-medium">
              {meta.label}
            </p>
          )}
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center gap-1 text-sm font-semibold text-primary-dark bg-white/70 backdrop-blur-sm rounded-full px-3 py-1 shadow-sm">
          {activities.length}
          <span class="text-xs font-normal text-gray-500">
            {activities.length > 1 ? "activit√©s" : "activit√©"}
          </span>
        </span>
        {/* Chevron */}
        <svg
          data-level-chevron
          xmlns="http://www.w3.org/2000/svg"
          class="w-5 h-5 text-primary-dark/50 transition-transform duration-300"
          style={defaultCollapsed ? "transform: rotate(-90deg)" : ""}
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
    </div>
  </button>

  {/* Collapsible content wrapper */}
  <div
    id={sectionId}
    data-level-content
    class={`grid transition-[grid-template-rows] duration-300 ease-in-out ${isExpanded ? "grid-rows-[1fr]" : "grid-rows-[0fr]"}`}
  >
    <div class="overflow-hidden">
      <ul class="grid gap-4 sm:gap-5 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 mt-5">
        {activities.map((fiche, index) => (
          <ActivityPreview fiche={fiche} eager={index < eagerCount} />
        ))}
      </ul>
    </div>
  </div>
</section>

<script is:inline>
  if (!window.__levelTogglesInit) {
    window.__levelTogglesInit = true;

    function _initLevelToggles() {
      document.querySelectorAll("[data-level-toggle]").forEach(function (btn) {
        if (btn.dataset.initialized) return;
        btn.dataset.initialized = "true";

        btn.addEventListener("click", function () {
          var targetId = btn.dataset.levelToggle;
          if (!targetId) return;

          var content = document.getElementById(targetId);
          if (!content) return;

          var isExpanded = btn.getAttribute("aria-expanded") === "true";
          var chevron = btn.querySelector("[data-level-chevron]");

          if (isExpanded) {
            btn.setAttribute("aria-expanded", "false");
            content.style.gridTemplateRows = "0fr";
            if (chevron) chevron.style.transform = "rotate(-90deg)";
          } else {
            btn.setAttribute("aria-expanded", "true");
            content.style.gridTemplateRows = "1fr";
            if (chevron) chevron.style.transform = "rotate(0deg)";
          }
        });
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", _initLevelToggles);
    } else {
      _initLevelToggles();
    }
  }
</script>
