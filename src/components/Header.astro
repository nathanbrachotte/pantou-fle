---
import LogoWithLabel from "@/components/LogoWithLabel.astro";
import NavPill from "@/components/NavPill.astro";
import { LEVELS } from "@/lib/constants";
import { getCurrentActivity, hasContent, levelHasAnyContent } from "@/lib/helpers";

interface Props {
  uri: string;
  pageData?: {
    activity: string;
    level: string;
  };
  availability?: Set<string>;
}

const { uri, pageData, availability = new Set<string>() } = Astro.props;

const LEVELS_LOGOS = ["ğŸ“š", "ğŸ£", "ğŸ¥", "ğŸ‘¶", "ğŸ“", "ğŸ‘¨", "ğŸ§“"] as const;
const LEVELS_LABELS = [
  "Tous",
  "A1",
  "A2",
  "B1",
  "B2",
  "C1",
  "C2",
] as const;

const isDev = import.meta.env.DEV;
const currentActivity = getCurrentActivity(uri, pageData?.activity);

function isLevelActive(level: string): boolean {
  const l = level.toLowerCase();
  if (l === "tous-niveaux") {
    return uri === "/" || uri.startsWith("/tous-niveaux");
  }
  return uri.startsWith(`/${l}/`) || uri.startsWith(`/${l}`);
}

function getLevelHref(level: string): string {
  return `/${level.toLowerCase()}/${currentActivity}`;
}

function isLevelDisabled(level: string): boolean {
  if (availability.size === 0) return false;
  return !hasContent(availability, level, currentActivity);
}
---

<header class="w-full relative">
  {isDev && (
    <div class="bg-pink-500 sm:bg-yellow-400 md:bg-green-400 lg:bg-blue-400 xl:bg-purple-400 2xl:bg-indigo-900 h-1" />
  )}

  <div class="relative mx-auto px-3 sm:px-4 lg:px-6">
    <div class="flex items-center gap-3 sm:gap-4 py-3 lg:py-4">
      <a href="/" class="flex-shrink-0">
        <span class="sr-only">Accueil</span>
        <LogoWithLabel />
      </a>

      <nav class="flex items-center gap-1.5 sm:gap-2 flex-wrap flex-1 z-10" aria-label="Niveaux">
        {LEVELS.map((level, index) => {
          if (!levelHasAnyContent(availability, level)) return null;
          return (
            <NavPill
              href={getLevelHref(level)}
              isActive={isLevelActive(level)}
              isDisabled={isLevelDisabled(level)}
            >
              <span class="leading-none" aria-hidden="true">{LEVELS_LOGOS[index]}</span>
              <span>{LEVELS_LABELS[index]}</span>
            </NavPill>
          );
        })}
      </nav>
    </div>
  </div>

</header>
