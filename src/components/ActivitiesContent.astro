---
import LevelSection from "@/components/LevelSection.astro";
import AdSense from "@/components/AdSense.astro";
import ActivityIcon from "@/components/ActivityIcon.astro";
import {
  getActivityTypeLabel,
  getActivityTypeBackgroundColor,
  activityTypeHasDarkBackground,
} from "@/lib/helpers";
import { cn } from "@/lib/utils";
import { AD_SLOTS } from "@/lib/constants";
import { LEVEL_ENUM, type Level } from "@/lib/constants";
import type { Activity } from "@/lib/contentful";

interface Props {
  activities: Activity[];
  activity: string;
  perLevel: Record<Level, Activity[]>;
}

const { activities, activity, perLevel } = Astro.props;

const LEVEL_KEYS: Level[] = [
  LEVEL_ENUM.A1,
  LEVEL_ENUM.A2,
  LEVEL_ENUM.B1,
  LEVEL_ENUM.B2,
  LEVEL_ENUM.C1,
  LEVEL_ENUM.C2,
];

const isEmpty = activities.length === 0;
const label = getActivityTypeLabel(activity, true);
const bgColor = getActivityTypeBackgroundColor(activity);
const darkBg = activityTypeHasDarkBackground(activity);

/** Collapse all sections by default when more than one level has content */
const levelsWithContent = LEVEL_KEYS.filter((l) => perLevel[l]?.length > 0).length;
const defaultCollapsed = levelsWithContent > 1;

/** The first expanded level section has above-the-fold images (up to 3 columns) */
const firstLevelWithContent = LEVEL_KEYS.find((l) => perLevel[l]?.length > 0);
---

{
  isEmpty ? (
    <div class="flex flex-col items-center justify-center p-12 text-center min-h-[340px]">
      <div class="mb-5 text-6xl">ðŸ“š</div>
      <h3 class="text-xl font-bold text-primary-dark mb-2">
        Aucun contenu disponible pour le moment
      </h3>
      <p class="text-gray-500 max-w-sm leading-relaxed">
        Il n'y a pas encore de contenu disponible pour cette section. Revenez
        plus tard !
      </p>
    </div>
  ) : (
    <div class="space-y-10 mt-4">
      {/* Page header with activity icon */}
      <div class="flex items-center justify-center gap-3">
        <span
          class={cn(
            "flex items-center justify-center w-10 h-10 rounded-xl",
            bgColor,
          )}
        >
          <ActivityIcon
            type={activity}
            class={cn("w-5 h-5", darkBg ? "text-white" : "text-primary-dark")}
          />
        </span>
        <h1 class="text-2xl sm:text-3xl font-extrabold text-primary-dark">
          {label}
        </h1>
        <span class="text-sm font-medium text-gray-400 bg-gray-100 rounded-full px-3 py-1">
          {activities.length}
        </span>
      </div>

      {/* Level sections */}
      {LEVEL_KEYS.map((level, index) => (
        <>
          <LevelSection
            level={level}
            activities={perLevel[level]}
            defaultCollapsed={defaultCollapsed}
            eagerCount={!defaultCollapsed && level === firstLevelWithContent ? 3 : 0}
          />
          {/* Ad between some sections */}
          {index === 1 && <AdSense adSlot={AD_SLOTS.BOTTOM_OF_PAGE} />}
        </>
      ))}
    </div>
  )
}
